#!/bin/bash

set -e

# Default language if not defined
IDIOMA="${IDIOMA:-ES}"

# Translation dictionary
declare -A mensajes

mensajes[CONFIGURANDO_ES]="==> Configurando %s para que se cargue automáticamente al inicio..."
mensajes[CONFIGURANDO_GL]="==> Configurando %s para que se cargue automaticamente ao inicio..."
mensajes[CONFIGURANDO_EN]="==> Configuring %s to load automatically at startup..."
mensajes[CONFIGURANDO_DE]="==> Konfiguriere %s für automatisches Laden beim Start..."
mensajes[CONFIGURANDO_FR]="==> Configuration de %s pour qu’il se charge automatiquement au démarrage..."
mensajes[CONFIGURANDO_PT]="==> Configurando %s para carregar automaticamente na inicialização..."
mensajes[CONFIGURANDO_IT]="==> Configurazione di %s per il caricamento automatico all'avvio..."

mensajes[AGREGADO_ES]="Agregado %s a %s"
mensajes[AGREGADO_GL]="Engadido %s a %s"
mensajes[AGREGADO_EN]="Added %s to %s"
mensajes[AGREGADO_DE]="%s zu %s hinzugefügt"
mensajes[AGREGADO_FR]="Ajouté %s à %s"
mensajes[AGREGADO_PT]="Adicionado %s a %s"
mensajes[AGREGADO_IT]="Aggiunto %s a %s"

mensajes[YA_ESTABA_ES]="%s ya estaba en %s"
mensajes[YA_ESTABA_GL]="%s xa estaba en %s"
mensajes[YA_ESTABA_EN]="%s was already in %s"
mensajes[YA_ESTABA_DE]="%s war bereits in %s"
mensajes[YA_ESTABA_FR]="%s était déjà dans %s"
mensajes[YA_ESTABA_PT]="%s já estava em %s"
mensajes[YA_ESTABA_IT]="%s era già presente in %s"

mensajes[CONF_ES]="Escrito configuración en %s"
mensajes[CONF_GL]="Escrita configuración en %s"
mensajes[CONF_EN]="Configuration written to %s"
mensajes[CONF_DE]="Konfiguration geschrieben in %s"
mensajes[CONF_FR]="Configuration écrite dans %s"
mensajes[CONF_PT]="Configuração escrita em %s"
mensajes[CONF_IT]="Configurazione scritta in %s"

mensajes[CARGANDO_ES]="Cargando módulo %s..."
mensajes[CARGANDO_GL]="Cargando o módulo %s..."
mensajes[CARGANDO_EN]="Loading module %s..."
mensajes[CARGANDO_DE]="Lade Modul %s..."
mensajes[CARGANDO_FR]="Chargement du module %s..."
mensajes[CARGANDO_PT]="Carregando módulo %s..."
mensajes[CARGANDO_IT]="Caricamento del modulo %s..."

mensajes[CARGADO_OK_ES]="Módulo cargado correctamente."
mensajes[CARGADO_OK_GL]="O módulo cargouse correctamente."
mensajes[CARGADO_OK_EN]="Module loaded successfully."
mensajes[CARGADO_OK_DE]="Modul erfolgreich geladen."
mensajes[CARGADO_OK_FR]="Module chargé avec succès."
mensajes[CARGADO_OK_PT]="Módulo carregado com sucesso."
mensajes[CARGADO_OK_IT]="Modulo caricato con successo."

mensajes[NO_CARGADO_ES]="No se pudo cargar el módulo. Inténtalo manualmente como root: modprobe v4l2loopback ..."
mensajes[NO_CARGADO_GL]="Non se puido cargar o módulo. Téntao manualmente como root: modprobe v4l2loopback ..."
mensajes[NO_CARGADO_EN]="Could not load the module. Try manually as root: modprobe v4l2loopback ..."
mensajes[NO_CARGADO_DE]="Modul konnte nicht geladen werden. Versuche es manuell als root: modprobe v4l2loopback ..."
mensajes[NO_CARGADO_FR]="Impossible de charger le module. Essayez manuellement en tant que root : modprobe v4l2loopback ..."
mensajes[NO_CARGADO_PT]="Não foi possível carregar o módulo. Tente manualmente como root: modprobe v4l2loopback ..."
mensajes[NO_CARGADO_IT]="Impossibile caricare il modulo. Prova manualmente come root: modprobe v4l2loopback ..."

mensajes[YA_CARGADO_ES]="El módulo ya está cargado."
mensajes[YA_CARGADO_GL]="O módulo xa está cargado."
mensajes[YA_CARGADO_EN]="The module is already loaded."
mensajes[YA_CARGADO_DE]="Das Modul ist bereits geladen."
mensajes[YA_CARGADO_FR]="Le module est déjà chargé."
mensajes[YA_CARGADO_PT]="O módulo já está carregado."
mensajes[YA_CARGADO_IT]="Il modulo è già caricato."

mensajes[FINAL_ES]="Configuración de %s finalizada."
mensajes[FINAL_GL]="Configuración de %s rematada."
mensajes[FINAL_EN]="Configuration of %s completed."
mensajes[FINAL_DE]="Konfiguration von %s abgeschlossen."
mensajes[FINAL_FR]="Configuration de %s terminée."
mensajes[FINAL_PT]="Configuração de %s concluída."
mensajes[FINAL_IT]="Configurazione di %s completata."

# Function to show translated message with parameters
_msg() {
  local clave="${1}_${IDIOMA}"
  local texto="${mensajes[$clave]}"
  shift
  printf "$texto\n" "$@"
}

MODULE_NAME="v4l2loopback"
MODPROBE_CONF="/etc/modprobe.d/v4l2loopback.conf"
MODULES_FILE="/etc/modules"

_msg CONFIGURANDO "$MODULE_NAME"

# Step 1: Add module to /etc/modules if not already present
if ! grep -q "^$MODULE_NAME" "$MODULES_FILE"; then
    echo "$MODULE_NAME" >> "$MODULES_FILE"
    _msg AGREGADO "$MODULE_NAME" "$MODULES_FILE"
else
    _msg YA_ESTABA "$MODULE_NAME" "$MODULES_FILE"
fi

# Step 2: Write module parameters to /etc/modprobe.d configuration file
echo "options $MODULE_NAME devices=1 video_nr=10 card_label=\"PhoneCam\" exclusive_caps=1" > "$MODPROBE_CONF"
_msg CONF "$MODPROBE_CONF"

# Step 3: Try to load the module now (non-fatal if already loaded)
if ! lsmod | grep -q "$MODULE_NAME"; then
    _msg CARGANDO "$MODULE_NAME"
    if modprobe "$MODULE_NAME" devices=1 video_nr=10 card_label="PhoneCam" exclusive_caps=1; then
        _msg CARGADO_OK
    else
        _msg NO_CARGADO
    fi
else
    _msg YA_CARGADO
fi

_msg FINAL "$MODULE_NAME"

chmod 440 /etc/sudoers.d/ipwebcam

